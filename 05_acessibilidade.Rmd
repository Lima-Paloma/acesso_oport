---
title: "Indicadores de acessibilidade"
author: "Ipea"
date: "27 de março de 2019"
output: github_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = "UTF-8") })
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE, eval = TRUE)


library(knitr)
library(readr)
library(ggplot2)
library(dplyr)
library(readxl)
library(scales)
library(sf)
library(mapview)
library(data.table)
library(opentripplanner)
library(purrr)
library(httr)
library(furrr)
# devtools::install_local("misc/patchwork-master.zip")
library(patchwork)

options(scipen = 999)

```

# Indicador de acesso cumulativo a oportunidades

Com a quantidade de oportunidades (saúde, educação, empregos) e a matriz de tempo de viagem calculadas entre os hexágonos, é hora da etapa de calcular o indicador de acessibilidade. Como projeto piloto, será calculado o indicador para as cidades de Fortaleza, Belo Horizonte e Rio de Janeiro.

```{r fun}

acess_acumu <- function(cidade, tempo) {
  
  dir_matriz <- sprintf("../data/output_ttmatrix/traveltime_matrix_%s_python.csv", cidade)
    
  # abrir matriz
  matriz_for <- read_csv(dir_matriz) %>%
    select(origin, destination, travel_time) %>%
    mutate(travel_time = travel_time/60)
  
  dir_hex <- sprintf("../data/hex_agregados/hex_agregado_%s.rds", cidade)
  
  # abrir oportunidades com hexagonos
  hexagonos_for_sf <- read_rds(dir_hex) %>%
    ungroup()
  
  # so populacao
  hexagonos_for_pop <- hexagonos_for_sf %>%
    st_set_geometry(NULL) %>%
    select(id_hex, pop_total)
  
  # outras variaveis
  hexagonos_for_vars <- hexagonos_for_sf %>%
    st_set_geometry(NULL) %>%
    select(-pop_total)
  
  
  # quantas oportunidades de escolas podem ser acessadas em menos de 40 minutos?
  # IDEIA: em de escolas, nao seria melhor considerar matriculas?
  
  access_ac_for <- matriz_for %>%
    left_join(hexagonos_for_vars, by = c("destination" = "id_hex")) %>%
    left_join(hexagonos_for_pop, by = c("origin" = "id_hex")) %>%
    group_by(origin, pop_total) %>%
    filter(travel_time < tempo) %>%
    summarise_at(vars(saude_total, escolas_total), sum) %>%
    mutate(tempo_viagem = tempo)
  
  access_ac_for_fim <- hexagonos_for_sf %>%
    select(id_hex) %>%
    left_join(access_ac_for, by = c("id_hex" = "origin"))
}


```


## Fortaleza

```{r acess acumulativa for}

acess_ac_for <- map_dfr(c(15, 30, 45, 60), ~ acess_acumu(cidade = "for", tempo = .x))

write_rds(acess_ac_for, "../data/output_access/access_ac_for.rds")


# adicionar competicao

# access_ac_for_fim %>%
#   select(id_hex, pop_total, saude_total) %>%
#   mutate(saude_por_pessoa = (saude_total/pop_total)*10) %>%
#   View()


# mapview(access_ac_for_fim, zcol = "saude_total")




```

Visualizar o indicador de acessibilidade para Fortaleza:

```{r viz for}

access_ac_for_fim %>%
 select(-escolas_total) %>%
  ggplot()+
  geom_sf(aes(fill = saude_total))+
  theme_bw()+
  theme(legend.position = "bottom")+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd")) +
access_ac_for_fim %>%
 select(-saude_total) %>%
  ggplot()+
  geom_sf(aes(fill = escolas_total))+
  theme_bw()+
  theme(legend.position = "bottom")+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd"))
  

```

## Belo Horizonte

Para Belo Horizonte:

```{r acess acumulativa bel}

acess_ac_bel <- map_dfr(c(15, 30, 45, 60), ~ acess_acumu(cidade = "bel", tempo = .x))

write_rds(acess_ac_bel, "../data/output_access/access_ac_bel.rds")

# mapview(access_ac_bel, zcol = "escolas_total")


# write_rds(access_ac_bel_fim, "../data/output_access/access_bel.rds")

```

Visualizar o indicador de acessibilidade para Belo Horizonte:

```{r viz bel}

access_ac_bel_fim %>%
 select(-escolas_total) %>%
  ggplot()+
  geom_sf(aes(fill = saude_total))+
  theme_bw()+
  theme(legend.position = "bottom")+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd")) +
access_ac_bel_fim %>%
 select(-saude_total) %>%
  ggplot()+
  geom_sf(aes(fill = escolas_total))+
  theme_bw()+
  theme(legend.position = "bottom")+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd"))
  

```

## Rio de Janeiro

Para o Rio de Janeiro:

```{r acess acumulativa rio}

acess_ac_rio <- map_dfr(c(15, 30, 45, 60), ~ acess_acumu(cidade = "rio", tempo = .x))

write_rds(acess_ac_rio, "../data/output_access/access_ac_rio.rds")

```

Visualizar o indicador de acessibilidade para Rio de Janeiro:

```{r viz rio}

access_ac_rio_fim %>%
 select(-escolas_total) %>%
  ggplot()+
  geom_sf(aes(fill = saude_total))+
  theme_bw()+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd")) +
access_ac_rio_fim %>%
 select(-saude_total) %>%
  ggplot()+
  geom_sf(aes(fill = escolas_total))+
  theme_bw()+
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(6, "PuRd"))+
    plot_layout(ncol = 1)
  

```
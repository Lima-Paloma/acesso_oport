---
title: "Diagnóstico GTFS Recife"
author: "Ipea"
date: "14 de março de 2019"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE, echo=FALSE, warning = FALSE, error = FALSE}
knitr::opts_chunk$set(include=FALSE, message=FALSE, echo=FALSE, warning = FALSE, error = FALSE)
library(tidyverse)
library(data.table)
library(kableExtra)

```

# GTFS de Recife


## ROUTES

```{r routes}

routes <- read_delim("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/routes.txt", delim = ',') %>%
  mutate(route_short_name = route_id,
         route_long_name = route_id) %>%
  select(route_id, agency_id, route_short_name, route_type)

```

Comentários: todos os ``route_type`` estao tipo 1, que significa metrô, e não onibus (tipo 3)

## SHAPES

```{r}

shapes <- read_delim("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/shapes.txt", delim = ',')
```

Comentários:
- O ``shape_id`` nao apresenta a informação se é ida ou volta


## STOPS

```{r}

stops <- read_delim("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/stops.txt", delim = ',') %>%
  select(stop_id, stop_name, stop_lat, stop_lon) %>%
  mutate(stop_name = paste0(stop_id, " - Parada"))

```

Comentários:
- coluna ``stop_name`` é obrigatória, porém apresenta muitos NA
- coluna ``location_type`` apresentava 0 e 1, repetido ate o fim

## TRIPS

```{r}

trips <- read_delim("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/trips.txt", delim = ',')

viagens <- trips %>%
  count(route_id, sort = T)

trips <- read_delim("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/trips.txt", delim = ',')

viagens <- trips %>%
  count(route_id, sort = T)

kable(viagens[1:10,])

```

Comentários: 
- Como mostra a tabela, tem rota com quase 11000 viagens!

```{r}

vai_169 <- trips %>%
  filter(route_id == "169")

vai_104 <- trips %>%
  filter(route_id == "104COMPLEMENTAR")

vai_2466 <- trips %>%
  filter(route_id == "2466")

vai_centro1 <- trips %>%
  filter(route_id == "LINHA CENTRO 1")

```

# STOP_TIMES

```{r}

stop_times <- fread("gtfs_teste/PMU-VIS-CALIB-ZONAS2996-V03-R_294 GTFS_190228/stop_times.txt")

# calcular o começo e fim de cada viagem

comeco_fim <- stop_times %>%
  group_by(trip_id) %>%
  summarise(inicio = first(arrival_time),
            fim = last(arrival_time))
```

Para checar as frequências fora do normal observadas acima, vamos ver a cada quanto tempo saem veículos das linhas 169, 104COMPLEMENTAR, 2466 E LINHA CENTRO 1:

```{r}

viagem_linha_169 <- stop_times %>%
  filter(trip_id %in% vai$trip_id) %>%
  group_by(trip_id) %>%
  mutate(headway = arrival_time - lag(arrival_time))

```


```{r}

tempo_viagem <- viagem_liha %>%
  group_by(trip_id) %>%
  summarise(travel_time = first(arrival_time)) %>%
  arrange(travel_time)

```

```




